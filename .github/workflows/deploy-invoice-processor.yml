name: Deploy AILANG Demos to GitHub Pages

on:
  push:
    branches: [main]
    paths:
      - 'invoice_processor_wasm/**'
      - 'docparse/**'
      - 'verify_demo/**'
      - 'streaming/**'
      - 'site/**'
      - '.github/workflows/deploy-invoice-processor.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download AILANG WASM tarball
        run: |
          set -euo pipefail
          WASM_DIR="invoice_processor_wasm/wasm"
          mkdir -p "$WASM_DIR"

          echo "::group::Fetching latest AILANG release info"
          RELEASE_JSON=$(curl -sfL \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/sunholo-data/ailang/releases/latest)
          RELEASE_TAG=$(echo "$RELEASE_JSON" | jq -r '.tag_name')
          echo "Latest release: $RELEASE_TAG"
          echo "::endgroup::"

          echo "::group::Downloading ailang-wasm.tar.gz"
          curl -sfL --retry 3 --retry-delay 5 \
            -o ailang-wasm.tar.gz \
            "https://github.com/sunholo-data/ailang/releases/download/${RELEASE_TAG}/ailang-wasm.tar.gz"
          echo "Tarball size: $(stat --printf='%s' ailang-wasm.tar.gz) bytes"
          echo "::endgroup::"

          echo "::group::Extracting tarball"
          tar -tzf ailang-wasm.tar.gz || { echo "::error::Tarball is corrupt"; exit 1; }
          tar -xzf ailang-wasm.tar.gz
          echo "Tarball contents:"
          tar -tzf ailang-wasm.tar.gz
          echo "::endgroup::"

          # Move ailang.wasm (required)
          if [ -f ailang.wasm ]; then
            mv ailang.wasm "$WASM_DIR/"
          else
            echo "::error::ailang.wasm not found in tarball"
            exit 1
          fi

          # Use wasm_exec.js from tarball if present, otherwise download from AILANG repo
          if [ -f wasm_exec.js ]; then
            echo "Using wasm_exec.js from release tarball"
            mv wasm_exec.js "$WASM_DIR/"
          else
            echo "wasm_exec.js not in tarball, downloading from AILANG repo..."
            curl -sfL --retry 3 --retry-delay 5 \
              -o "$WASM_DIR/wasm_exec.js" \
              "https://raw.githubusercontent.com/sunholo-data/ailang/${RELEASE_TAG}/docs/static/wasm/wasm_exec.js"
          fi

          # Use ailang-repl.js from tarball if present, otherwise download from AILANG repo
          if [ -f ailang-repl.js ]; then
            echo "Using ailang-repl.js from release tarball"
            mv ailang-repl.js "$WASM_DIR/"
          else
            echo "ailang-repl.js not in tarball, downloading from AILANG repo..."
            curl -sfL --retry 3 --retry-delay 5 \
              -o "$WASM_DIR/ailang-repl.js" \
              "https://raw.githubusercontent.com/sunholo-data/ailang/${RELEASE_TAG}/web/ailang-repl.js"
          fi

      - name: Verify WASM files
        run: |
          set -euo pipefail
          WASM_DIR="invoice_processor_wasm/wasm"
          echo "::group::File listing"
          ls -lh "$WASM_DIR/"
          echo "::endgroup::"

          FAIL=0

          # ailang.wasm — should be >1MB (currently ~34MB)
          WASM_SIZE=$(stat --printf='%s' "$WASM_DIR/ailang.wasm")
          if [ "$WASM_SIZE" -lt 1000000 ]; then
            echo "::error::ailang.wasm is only ${WASM_SIZE} bytes (expected >1MB)"
            FAIL=1
          else
            echo "ailang.wasm: ${WASM_SIZE} bytes — OK"
          fi

          # wasm_exec.js — should be >10KB
          EXEC_SIZE=$(stat --printf='%s' "$WASM_DIR/wasm_exec.js")
          if [ "$EXEC_SIZE" -lt 10000 ]; then
            echo "::error::wasm_exec.js is only ${EXEC_SIZE} bytes (expected >10KB)"
            FAIL=1
          else
            echo "wasm_exec.js: ${EXEC_SIZE} bytes — OK"
          fi

          # ailang-repl.js — should be >3KB
          REPL_SIZE=$(stat --printf='%s' "$WASM_DIR/ailang-repl.js")
          if [ "$REPL_SIZE" -lt 3000 ]; then
            echo "::error::ailang-repl.js is only ${REPL_SIZE} bytes (expected >3KB)"
            FAIL=1
          else
            echo "ailang-repl.js: ${REPL_SIZE} bytes — OK"
          fi

          if [ "$FAIL" -ne 0 ]; then
            echo "::error::WASM file verification failed"
            exit 1
          fi

          echo "All WASM files verified successfully"

      - name: Copy docparse modules
        run: |
          # Clean up any dev symlinks and set up real files for deployment
          rm -rf invoice_processor_wasm/ailang/docparse
          mkdir -p invoice_processor_wasm/ailang/docparse/types
          mkdir -p invoice_processor_wasm/ailang/docparse/services
          # Copy original source modules (single source of truth)
          cp docparse/types/document.ail invoice_processor_wasm/ailang/docparse/types/
          cp docparse/services/format_router.ail invoice_processor_wasm/ailang/docparse/services/
          cp docparse/services/zip_extract.ail invoice_processor_wasm/ailang/docparse/services/
          cp docparse/services/docx_parser.ail invoice_processor_wasm/ailang/docparse/services/
          cp docparse/services/pptx_parser.ail invoice_processor_wasm/ailang/docparse/services/
          cp docparse/services/xlsx_parser.ail invoice_processor_wasm/ailang/docparse/services/
          cp docparse/services/output_formatter.ail invoice_processor_wasm/ailang/docparse/services/
          cp docparse/services/docparse_browser.ail invoice_processor_wasm/ailang/docparse/services/
          echo "Copied $(find invoice_processor_wasm/ailang/docparse -name '*.ail' | wc -l) docparse modules"

      - name: Copy verify_demo modules
        run: |
          # Clean up any dev symlinks and set up real files for deployment
          rm -rf invoice_processor_wasm/ailang/verify_demo
          mkdir -p invoice_processor_wasm/ailang/verify_demo
          # Copy verification demo source modules
          cp verify_demo/verify_showcase.ail invoice_processor_wasm/ailang/verify_demo/
          cp verify_demo/billing.ail invoice_processor_wasm/ailang/verify_demo/
          cp verify_demo/access_policy.ail invoice_processor_wasm/ailang/verify_demo/
          cp verify_demo/scheduling.ail invoice_processor_wasm/ailang/verify_demo/
          cp verify_demo/main.ail invoice_processor_wasm/ailang/verify_demo/
          echo "Copied $(find invoice_processor_wasm/ailang/verify_demo -name '*.ail' | wc -l) verify_demo modules"

      - name: Copy demo Office files
        run: |
          # Copy representative test files for demo buttons
          cp docparse/data/test_files/sample.docx invoice_processor_wasm/assets/
          cp docparse/data/test_files/tables.docx invoice_processor_wasm/assets/
          cp docparse/data/test_files/merged_cells.docx invoice_processor_wasm/assets/
          cp docparse/data/test_files/python_pptx_slides.pptx invoice_processor_wasm/assets/
          cp docparse/data/test_files/python_pptx_table.pptx invoice_processor_wasm/assets/
          cp docparse/data/test_files/pandoc_basic.pptx invoice_processor_wasm/assets/
          cp docparse/data/test_files/pandoc_basic.xlsx invoice_processor_wasm/assets/
          cp docparse/data/test_files/comments.docx invoice_processor_wasm/assets/
          cp docparse/data/test_files/track_changes_move.docx invoice_processor_wasm/assets/
          echo "Copied $(ls invoice_processor_wasm/assets/*.docx invoice_processor_wasm/assets/*.pptx invoice_processor_wasm/assets/*.xlsx 2>/dev/null | wc -l) demo Office files to assets/"

      - name: Assemble site
        run: |
          set -euo pipefail
          mkdir -p _site

          # Hub page
          cp site/index.html _site/

          # WASM demos (rename index.html → extractor.html)
          cp -r invoice_processor_wasm/* _site/
          mv _site/index.html _site/extractor.html

          # Streaming shared assets
          mkdir -p _site/streaming/shared
          cp streaming/shared/audio-worklet.js _site/streaming/shared/
          cp streaming/shared/nav.js _site/streaming/shared/

          # Streaming demos (each browser/index.html → streaming/<demo>/index.html)
          for demo in claude_chat gemini_live safe_agent transcription \
                      voice_analytics voice_docparse voice_pipeline; do
            mkdir -p "_site/streaming/${demo}"
            cp "streaming/${demo}/browser/index.html" "_site/streaming/${demo}/"
          done

          echo "::group::Site contents"
          find _site -type f | head -60
          echo "::endgroup::"
          echo "Assembled $(find _site -type f | wc -l) files into _site/"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
