<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AILANG Safe Agent — Contract-Verified Business Tools</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
  /* ================================================================
     AILANG Safe Agent — Mission Control UI
     Split-screen: Conversation (left 60%) + Safety Dashboard (right 40%)
     ================================================================ */

  :root {
    --bg-deep: #05070a;
    --bg-primary: #0a0d12;
    --bg-raised: #0f1318;
    --bg-surface: #141920;
    --bg-card: #181e28;
    --bg-hover: #1c2330;
    --border: #1a2030;
    --border-active: #253040;
    --border-bright: #304060;

    --text-primary: #d8dce6;
    --text-secondary: #8892a4;
    --text-muted: #556078;
    --text-dim: #2d3548;

    /* Accent palette */
    --green: #00e576;
    --green-bright: #2aff96;
    --green-dim: #0a3d22;
    --green-glow: rgba(0, 229, 118, 0.15);
    --green-subtle: rgba(0, 229, 118, 0.06);

    --red: #ff3b5c;
    --red-bright: #ff5c7a;
    --red-dim: #3d0a16;
    --red-glow: rgba(255, 59, 92, 0.15);

    --amber: #ffb020;
    --amber-dim: #3d2a08;
    --amber-glow: rgba(255, 176, 32, 0.12);

    --blue: #3b8cff;
    --blue-dim: #0a1e3d;
    --blue-glow: rgba(59, 140, 255, 0.12);

    --cyan: #00d4ff;
    --cyan-dim: #002a3d;

    --purple: #a47cff;

    /* Typography */
    --font-mono: 'JetBrains Mono', 'SF Mono', 'Cascadia Code', 'Fira Code', monospace;
    --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;

    /* Ring */
    --ring-size: 120px;
    --ring-stroke: 10;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    height: 100%;
    background: var(--bg-deep);
    color: var(--text-primary);
    font-family: var(--font-mono);
    font-size: 13px;
    line-height: 1.55;
    overflow: hidden;
    -webkit-font-smoothing: antialiased;
  }

  /* Subtle grid overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(255,255,255,0.01) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.01) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* Scanline overlay */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.015) 2px,
      rgba(0,0,0,0.015) 4px
    );
    pointer-events: none;
    z-index: 9999;
  }

  /* ── App Shell ── */
  .app {
    display: grid;
    grid-template-rows: auto auto 1fr auto;
    height: 100vh;
    position: relative;
    z-index: 1;
  }

  /* ================================================================
     TOP BAR
     ================================================================ */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 20px;
    background: var(--bg-primary);
    border-bottom: 1px solid var(--border);
    gap: 12px;
    flex-wrap: wrap;
    position: relative;
    z-index: 10;
  }

  .topbar::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--green-dim), var(--green), var(--green-dim), transparent);
    opacity: 0.5;
  }

  .topbar-left {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .logo {
    font-family: var(--font-sans);
    font-size: 15px;
    font-weight: 800;
    letter-spacing: -0.3px;
    color: var(--text-primary);
  }

  .logo .accent { color: var(--green); }
  .logo .dim { color: var(--text-muted); font-weight: 400; }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 10px;
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  .badge-contract {
    background: var(--green-dim);
    border: 1px solid rgba(0, 229, 118, 0.25);
    color: var(--green);
  }

  .badge-contract .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 8px var(--green);
    animation: pulse-green 2s ease-in-out infinite;
  }

  @keyframes pulse-green {
    0%, 100% { opacity: 1; box-shadow: 0 0 8px var(--green); }
    50% { opacity: 0.5; box-shadow: 0 0 3px var(--green); }
  }

  .badge-gemini {
    background: var(--blue-dim);
    border: 1px solid rgba(59, 140, 255, 0.25);
    color: var(--blue);
  }

  .badge-wasm {
    background: var(--cyan-dim);
    border: 1px solid rgba(0, 212, 255, 0.25);
    color: var(--cyan);
  }

  .badge-ws {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    color: var(--text-muted);
    transition: all 0.3s;
  }

  .badge-ws.connected {
    background: var(--green-dim);
    border-color: rgba(0, 229, 118, 0.25);
    color: var(--green);
  }

  .badge-ws .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--text-muted);
    transition: all 0.3s;
  }

  .badge-ws.connected .dot {
    background: var(--green);
    box-shadow: 0 0 6px var(--green);
    animation: pulse-green 2s ease-in-out infinite;
  }

  .topbar-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn-topbar {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: 4px 12px;
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.3px;
    text-transform: uppercase;
  }

  .btn-topbar:hover {
    border-color: var(--border-active);
    color: var(--text-secondary);
    background: var(--bg-raised);
  }

  .btn-topbar.active {
    border-color: rgba(0, 229, 118, 0.3);
    color: var(--green);
    background: var(--green-dim);
  }

  /* ── Config Panel ── */
  .config-panel {
    background: var(--bg-primary);
    border-bottom: 1px solid var(--border);
    overflow: hidden;
    max-height: 0;
    transition: max-height 0.35s ease, padding 0.35s ease;
    padding: 0 20px;
  }

  .config-panel.open {
    max-height: 200px;
    padding: 14px 20px;
  }

  .config-note {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    padding: 8px 12px;
    background: var(--amber-dim);
    border: 1px solid rgba(255, 176, 32, 0.15);
    border-radius: 4px;
    margin-bottom: 12px;
    font-size: 11px;
    color: var(--amber);
    line-height: 1.6;
  }

  .config-note code {
    background: var(--bg-surface);
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 10px;
  }

  .config-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }

  .config-row label {
    font-size: 11px;
    color: var(--text-muted);
    white-space: nowrap;
    min-width: 70px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .config-input {
    flex: 1;
    background: var(--bg-deep);
    border: 1px solid var(--border);
    color: var(--text-primary);
    padding: 7px 12px;
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 12px;
    outline: none;
    transition: border-color 0.15s;
  }

  .config-input:focus { border-color: var(--green-dim); }
  .config-input::placeholder { color: var(--text-dim); }

  /* ================================================================
     MAIN CONTENT — SPLIT SCREEN
     ================================================================ */
  .main-split {
    display: grid;
    grid-template-columns: 1fr 0.67fr;
    overflow: hidden;
    min-height: 0;
  }

  /* ── Left Panel: Conversation ── */
  .panel-conversation {
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border);
    min-height: 0;
    position: relative;
  }

  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: var(--bg-raised);
    border-bottom: 1px solid var(--border);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    font-weight: 600;
    flex-shrink: 0;
  }

  .panel-header .indicator {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .panel-header .indicator .dot-sm {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--text-dim);
  }

  .panel-header .indicator .dot-sm.active {
    background: var(--green);
    box-shadow: 0 0 4px var(--green);
  }

  /* Messages area */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    scroll-behavior: smooth;
    background:
      radial-gradient(ellipse at 30% 0%, rgba(0, 229, 118, 0.015) 0%, transparent 50%),
      var(--bg-deep);
  }

  .messages::-webkit-scrollbar { width: 5px; }
  .messages::-webkit-scrollbar-track { background: transparent; }
  .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .messages::-webkit-scrollbar-thumb:hover { background: var(--border-active); }

  /* Welcome */
  .welcome {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    text-align: center;
    padding: 40px 30px;
    gap: 16px;
  }

  .welcome-shield {
    width: 64px;
    height: 64px;
    position: relative;
  }

  .welcome-shield svg {
    width: 64px;
    height: 64px;
    filter: drop-shadow(0 0 20px var(--green-glow));
  }

  .welcome h2 {
    font-family: var(--font-sans);
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    letter-spacing: -0.3px;
  }

  .welcome p {
    font-size: 12px;
    color: var(--text-muted);
    max-width: 360px;
    line-height: 1.7;
  }

  .welcome kbd {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 10px;
    font-family: var(--font-mono);
    color: var(--text-secondary);
  }

  .welcome .feature-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: center;
    margin-top: 4px;
  }

  .welcome .feature-tag {
    font-size: 10px;
    padding: 3px 10px;
    border-radius: 3px;
    font-weight: 500;
    letter-spacing: 0.3px;
  }

  .feature-tag.calc { background: var(--green-dim); color: var(--green); border: 1px solid rgba(0,229,118,0.15); }
  .feature-tag.file { background: var(--blue-dim); color: var(--blue); border: 1px solid rgba(59,140,255,0.15); }
  .feature-tag.sql { background: var(--amber-dim); color: var(--amber); border: 1px solid rgba(255,176,32,0.15); }
  .feature-tag.div { background: var(--red-dim); color: var(--red); border: 1px solid rgba(255,59,92,0.15); }

  .welcome .init-log {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
    text-align: left;
    max-width: 360px;
    margin-top: 4px;
    line-height: 1.8;
  }
  .welcome .init-log .ok { color: var(--green); }

  /* Messages */
  .msg {
    max-width: 92%;
    flex-shrink: 0;
    animation: msg-in 0.25s ease-out;
  }

  @keyframes msg-in {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .msg-user {
    align-self: flex-end;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px 10px 2px 10px;
    padding: 10px 14px;
  }

  .msg-label {
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .msg-user .msg-label {
    color: var(--text-dim);
    text-align: right;
  }

  .msg-agent {
    align-self: flex-start;
    padding: 8px 0;
  }

  .msg-agent .msg-label {
    color: var(--green-dim);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .msg-agent .msg-label .arrow { color: var(--green); font-size: 10px; }

  .msg-text {
    font-size: 13px;
    line-height: 1.65;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .msg-agent .msg-text {
    padding-left: 14px;
    border-left: 2px solid var(--border);
    color: var(--text-primary);
  }

  .msg-agent.streaming .msg-text {
    border-left-color: var(--green-dim);
  }

  .cursor-blink {
    display: inline-block;
    width: 7px;
    height: 14px;
    background: var(--green);
    margin-left: 2px;
    vertical-align: text-bottom;
    animation: blink 0.6s step-end infinite;
    box-shadow: 0 0 8px var(--green-glow);
  }

  @keyframes blink {
    50% { opacity: 0; }
  }

  .msg-error {
    align-self: center;
    background: var(--red-dim);
    border: 1px solid rgba(255, 59, 92, 0.2);
    border-radius: 6px;
    padding: 8px 14px;
    color: var(--red);
    font-size: 12px;
  }

  .msg-system {
    align-self: center;
    color: var(--text-dim);
    font-size: 11px;
    padding: 4px 12px;
    border: 1px dashed var(--border);
    border-radius: 4px;
    font-style: italic;
  }

  /* ── Tool Call Cards ── */
  .tool-card {
    align-self: flex-start;
    width: 100%;
    max-width: 92%;
    flex-shrink: 0;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    animation: msg-in 0.3s ease-out;
  }

  .tool-card.pass { border-color: rgba(0, 229, 118, 0.2); }
  .tool-card.fail { border-color: rgba(255, 59, 92, 0.2); }

  .tool-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: var(--bg-raised);
    border-bottom: 1px solid var(--border);
    gap: 8px;
    cursor: pointer;
    user-select: none;
  }
  .tool-card-header:hover { background: var(--bg-card); }
  .tool-card.collapsed .tool-card-body { display: none; }

  .tool-card-header .tool-name {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-primary);
    font-family: var(--font-mono);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .tool-card-header .tool-name .fn-icon {
    color: var(--purple);
    font-size: 10px;
    font-weight: 400;
  }

  .tool-card-header .contract-badge {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.3px;
    padding: 2px 8px;
    border-radius: 3px;
  }

  .contract-badge.pass {
    background: var(--green-dim);
    color: var(--green);
  }

  .contract-badge.fail {
    background: var(--red-dim);
    color: var(--red);
  }

  .contract-badge.blocked {
    background: rgba(255, 176, 46, 0.12);
    color: var(--amber);
  }

  .contract-badge .icon { font-size: 11px; }

  .tool-card-body {
    padding: 0;
    font-size: 11px;
    line-height: 1.7;
    display: block;
  }

  .tc-section {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
  }
  .tc-section:last-child { border-bottom: none; }

  .tc-section-label {
    font-size: 8px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--text-dim);
    margin-bottom: 4px;
  }

  .tc-section-content {
    color: var(--text-secondary);
    font-family: var(--font-mono);
    font-size: 11px;
    word-break: break-all;
    line-height: 1.6;
  }

  .tc-section-content.result { color: var(--green); font-weight: 600; }
  .tc-section-content.rejected { color: var(--red); font-weight: 600; }

  .tc-section .contract-checks {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .check-pill {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-size: 9px;
    font-weight: 500;
    padding: 2px 7px;
    border-radius: 3px;
    letter-spacing: 0.3px;
  }

  .check-pill.pass {
    background: var(--green-dim);
    color: var(--green);
    border: 1px solid rgba(0, 229, 118, 0.1);
  }

  .check-pill.fail {
    background: var(--red-dim);
    color: var(--red);
    border: 1px solid rgba(255, 59, 92, 0.1);
  }

  /* ── Input Area ── */
  .input-area {
    background: var(--bg-primary);
    border-top: 1px solid var(--border);
    padding: 12px 16px;
    flex-shrink: 0;
  }

  .input-row {
    display: flex;
    gap: 8px;
    align-items: flex-end;
  }

  .btn-mic {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .btn-mic:hover {
    border-color: var(--green-dim);
    color: var(--green);
    background: var(--green-dim);
  }

  .btn-mic.recording {
    background: var(--red-dim);
    border-color: rgba(255, 59, 92, 0.4);
    color: var(--red);
    animation: mic-pulse 1.5s ease-in-out infinite;
  }

  @keyframes mic-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(255, 59, 92, 0.3); }
    50% { box-shadow: 0 0 0 8px rgba(255, 59, 92, 0); }
  }

  .btn-mic svg { width: 18px; height: 18px; }

  .input-wrap {
    flex: 1;
    position: relative;
  }

  .input-field {
    width: 100%;
    background: var(--bg-deep);
    border: 1px solid var(--border);
    color: var(--text-primary);
    padding: 10px 14px;
    border-radius: 6px;
    font-family: var(--font-mono);
    font-size: 13px;
    line-height: 1.5;
    resize: none;
    outline: none;
    min-height: 42px;
    max-height: 120px;
    transition: border-color 0.15s;
  }

  .input-field:focus { border-color: rgba(0, 229, 118, 0.3); }
  .input-field::placeholder { color: var(--text-dim); }

  /* ── Audio Scope Strip ── */
  .scope-strip {
    grid-column: 1 / -1;
    height: 64px;
    background: var(--bg-deep);
    border-bottom: 1px solid var(--border);
    position: relative;
    overflow: hidden;
  }
  .scope-strip canvas {
    width: 100%;
    height: 64px;
    display: block;
  }
  .scope-strip .vu-strip {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 3px 12px;
    background: rgba(0,0,0,0.4);
  }
  .vu-label { font-family: var(--font-mono); font-size: 8px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
  .vu-track { flex: 1; height: 3px; background: var(--bg-card); border-radius: 2px; overflow: hidden; }
  .vu-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--green) 0%, var(--green-bright, #5fff97) 80%, var(--red) 100%); border-radius: 2px; transition: width 0.1s ease-out; }
  .vu-db { font-family: var(--font-mono); font-size: 8px; color: var(--text-dim); min-width: 36px; text-align: right; }

  .btn-send {
    background: var(--green);
    color: var(--bg-deep);
    border: none;
    padding: 10px 18px;
    border-radius: 6px;
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    white-space: nowrap;
    height: 42px;
  }

  .btn-send:hover { background: var(--green-bright); }

  .btn-send:disabled {
    background: var(--bg-surface);
    color: var(--text-dim);
    cursor: not-allowed;
  }

  /* ================================================================
     RIGHT PANEL: SAFETY DASHBOARD
     ================================================================ */
  .panel-safety {
    display: flex;
    flex-direction: column;
    min-height: 0;
    background:
      radial-gradient(ellipse at 70% 20%, rgba(0, 229, 118, 0.02) 0%, transparent 50%),
      var(--bg-deep);
  }

  .safety-split {
    flex: 1;
    display: grid;
    grid-template-columns: auto 1fr;
    min-height: 0;
  }

  .safety-summary {
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border);
    overflow-y: auto;
    min-width: 180px;
    max-width: 220px;
  }
  .safety-summary::-webkit-scrollbar { width: 3px; }
  .safety-summary::-webkit-scrollbar-track { background: transparent; }
  .safety-summary::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* ── Percentage Ring ── */
  .safety-ring-section {
    padding: 12px 12px 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .ring-container {
    position: relative;
    width: var(--ring-size);
    height: var(--ring-size);
  }

  .ring-svg {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
  }

  .ring-bg {
    fill: none;
    stroke: var(--bg-surface);
    stroke-width: var(--ring-stroke);
  }

  .ring-fill {
    fill: none;
    stroke: var(--green);
    stroke-width: var(--ring-stroke);
    stroke-linecap: round;
    transition: stroke-dashoffset 0.6s ease, stroke 0.3s;
    filter: drop-shadow(0 0 6px var(--green-glow));
  }

  .ring-center {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .ring-pct {
    font-family: var(--font-sans);
    font-size: 28px;
    font-weight: 800;
    color: var(--green);
    letter-spacing: -1px;
    line-height: 1;
    transition: color 0.3s;
  }

  .ring-label {
    font-size: 9px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 2px;
  }

  .ring-sublabel {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-secondary);
    font-weight: 500;
    margin-top: 2px;
    text-align: center;
    line-height: 1.3;
  }

  /* ── Tool Status Cards ── */
  .safety-cards {
    padding: 8px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex-shrink: 0;
  }

  .safety-card {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 4px;
    transition: all 0.2s;
  }

  .safety-card:hover { border-color: var(--border-active); }

  .safety-card .sc-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
    transition: all 0.3s;
  }

  .safety-card .sc-indicator.green { background: var(--green); box-shadow: 0 0 6px var(--green-glow); }
  .safety-card .sc-indicator.amber { background: var(--amber); box-shadow: 0 0 6px var(--amber-glow); }
  .safety-card .sc-indicator.red { background: var(--red); box-shadow: 0 0 6px var(--red-glow); }
  .safety-card .sc-indicator.dim { background: var(--text-dim); }

  .safety-card .sc-content {
    flex: 1;
    min-width: 0;
  }

  .safety-card .sc-title {
    font-family: var(--font-sans);
    font-size: 12px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 1px;
  }

  .safety-card .sc-detail {
    font-size: 10px;
    color: var(--text-muted);
    line-height: 1.4;
  }

  .safety-card .sc-params {
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--text-dim);
    margin-top: 2px;
    line-height: 1.3;
  }

  .safety-card .sc-stats {
    text-align: right;
    flex-shrink: 0;
  }

  .safety-card .sc-count {
    font-family: var(--font-mono);
    font-size: 14px;
    font-weight: 700;
    color: var(--text-secondary);
    line-height: 1;
  }

  .safety-card .sc-sublabel {
    font-size: 8px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 2px;
  }

  /* ── Contract Log ── */
  .contract-log {
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
  }

  .log-header {
    padding: 8px 14px;
    background: var(--bg-raised);
    border-bottom: 1px solid var(--border);
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  .log-header .log-count {
    font-family: var(--font-mono);
    color: var(--text-dim);
    font-weight: 400;
  }


  .log-entries {
    flex: 1;
    overflow-y: auto;
    padding: 6px 0;
    scroll-behavior: smooth;
  }

  .log-entries::-webkit-scrollbar { width: 4px; }
  .log-entries::-webkit-scrollbar-track { background: transparent; }
  .log-entries::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .log-entry {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    padding: 5px 14px;
    font-size: 10px;
    line-height: 1.5;
    animation: log-in 0.2s ease-out;
    border-left: 2px solid transparent;
  }

  .log-entry:hover { background: var(--bg-raised); }

  .log-entry.pass { border-left-color: var(--green); }
  .log-entry.fail { border-left-color: var(--red); }

  @keyframes log-in {
    from { opacity: 0; transform: translateX(8px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .log-entry .log-time {
    color: var(--text-dim);
    font-family: var(--font-mono);
    white-space: nowrap;
    min-width: 55px;
    font-variant-numeric: tabular-nums;
  }

  .log-entry .log-icon {
    font-size: 11px;
    flex-shrink: 0;
    width: 14px;
    text-align: center;
  }

  .log-entry .log-icon.pass { color: var(--green); }
  .log-entry .log-icon.fail { color: var(--red); }

  .log-entry .log-msg {
    color: var(--text-secondary);
    flex: 1;
    min-width: 0;
    cursor: pointer;
  }
  .log-entry .log-detail {
    display: none;
    margin-top: 6px;
    padding: 8px 10px;
    background: var(--bg-deep);
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 10px;
    line-height: 1.7;
    color: var(--text-secondary);
    word-break: break-all;
    border: 1px solid var(--border);
  }
  .log-entry.expanded .log-detail { display: block; }
  .log-entry .log-detail .detail-label {
    font-size: 8px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    margin-top: 4px;
  }
  .log-entry .log-detail .detail-label:first-child { margin-top: 0; }
  .log-entry .log-detail .detail-value {
    color: var(--text-secondary);
    margin-bottom: 2px;
  }
  .log-entry .log-detail .detail-value.ok { color: var(--green); }
  .log-entry .log-detail .detail-value.err { color: var(--red); }

  .log-entry .log-msg .fn { color: var(--purple); font-weight: 600; }
  .log-entry .log-msg .val { color: var(--cyan); }
  .log-entry .log-msg .err { color: var(--red); }

  .log-empty {
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
    color: var(--text-dim);
    font-size: 11px;
    font-style: italic;
    padding: 20px;
  }

  /* ================================================================
     FOOTER — BUDGET METERS
     ================================================================ */
  .footer-budgets {
    display: flex;
    align-items: center;
    padding: 6px 20px;
    background: var(--bg-raised);
    border-top: 1px solid var(--border);
    gap: 20px;
    flex-wrap: wrap;
    min-height: 32px;
  }

  .budget-meter {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 10px;
    font-weight: 500;
  }

  .budget-meter .bm-label {
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-width: 40px;
  }

  .budget-meter .bm-bar-wrap {
    width: 80px;
    height: 4px;
    background: var(--bg-surface);
    border-radius: 2px;
    overflow: hidden;
    position: relative;
  }

  .budget-meter .bm-bar {
    height: 100%;
    border-radius: 2px;
    transition: width 0.4s ease, background 0.3s;
    background: var(--green);
  }

  .budget-meter .bm-bar.warn { background: var(--amber); }
  .budget-meter .bm-bar.danger { background: var(--red); }

  .budget-meter .bm-text {
    color: var(--text-dim);
    font-family: var(--font-mono);
    font-variant-numeric: tabular-nums;
    min-width: 50px;
  }

  .footer-spacer { flex: 1; }

  .footer-branding {
    font-size: 9px;
    color: var(--text-dim);
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  .footer-branding .ail { color: var(--green); font-weight: 600; }

  /* ================================================================
     RESPONSIVE
     ================================================================ */
  @media (max-width: 900px) {
    .main-split {
      grid-template-columns: 1fr;
      grid-template-rows: 1fr 1fr;
    }
    .panel-conversation { border-right: none; border-bottom: 1px solid var(--border); }
    .safety-split {
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr;
    }
    .safety-summary {
      border-right: none;
      border-bottom: 1px solid var(--border);
      max-width: none;
      flex-direction: row;
      overflow-y: visible;
    }
    .safety-ring-section { padding: 8px; }
    .safety-cards { flex-direction: row; flex-wrap: wrap; }
  }

  @media (max-width: 600px) {
    .topbar { padding: 8px 12px; }
    .badge-gemini { display: none; }
    .footer-budgets { padding: 6px 12px; gap: 12px; }
    .budget-meter .bm-bar-wrap { width: 50px; }
  }
</style>
</head>
<body>

<div class="app">
  <!-- ============================================================
       TOP BAR
       ============================================================ -->
  <div class="topbar">
    <div class="topbar-left">
      <div class="logo"><span class="accent">AILANG</span> <span class="dim">Safe Agent</span></div>
      <span class="badge badge-contract"><span class="dot"></span> Contract-Verified</span>
      <span class="badge badge-wasm">WASM</span>
      <span class="badge badge-gemini">Gemini Live</span>
      <span class="badge badge-ws" id="wsStatus"><span class="dot"></span> <span id="wsLabel">Disconnected</span></span>
    </div>
    <div class="topbar-right">
      <button class="btn-topbar" id="btnTestSafety" onclick="runSafetyTest()" disabled>Test Safety</button>
      <button class="btn-topbar" id="btnConfig" onclick="toggleConfig()">Config</button>
    </div>
  </div>

  <!-- Config Panel -->
  <div class="config-panel" id="configPanel">
    <div class="config-note">
      <span>*</span>
      <span>Connects directly to <code>wss://generativelanguage.googleapis.com</code> via AILANG WASM
      (std/stream effects). The Gemini API key is stored in localStorage only.</span>
    </div>
    <div class="config-row">
      <label>API Key</label>
      <input type="password" class="config-input" id="apiKeyInput"
             placeholder="AIza..." autocomplete="off"
             onchange="saveConfig()">
    </div>
    <div class="config-row">
      <label>Voice</label>
      <select class="config-input" id="voiceSelect" onchange="saveConfig()">
        <option value="Orus" selected>Orus (Firm)</option>
        <option value="Charon">Charon (Informative)</option>
        <option value="Schedar">Schedar (Even)</option>
        <option value="Sulafat">Sulafat (Warm)</option>
        <option value="Sadaltager">Sadaltager (Knowledgeable)</option>
        <option value="Gacrux">Gacrux (Mature)</option>
        <option value="Rasalgethi">Rasalgethi (Informative)</option>
        <option value="Alnilam">Alnilam (Firm)</option>
        <option value="Puck">Puck (Upbeat)</option>
        <option value="Kore">Kore (Firm)</option>
        <option value="Zephyr">Zephyr (Bright)</option>
        <option value="Aoede">Aoede (Breezy)</option>
        <option value="Fenrir">Fenrir (Excitable)</option>
        <option value="Leda">Leda (Youthful)</option>
      </select>
    </div>
  </div>

  <!-- Audio Scope Strip -->
  <div class="scope-strip">
    <canvas id="waveform"></canvas>
    <div class="vu-strip">
      <span class="vu-label">VU</span>
      <div class="vu-track"><div class="vu-fill" id="vuFill"></div></div>
      <span class="vu-db" id="vuDb">-&infin; dB</span>
    </div>
  </div>

  <!-- ============================================================
       MAIN SPLIT: Conversation + Safety Dashboard
       ============================================================ -->
  <div class="main-split">
    <!-- Left Panel: Conversation -->
    <div class="panel-conversation">
      <div class="panel-header">
        <span>Conversation</span>
        <div class="indicator">
          <span class="dot-sm" id="streamDot"></span>
          <span id="streamLabel">idle</span>
        </div>
      </div>

      <div class="messages" id="messages">
        <div class="welcome" id="welcome">
          <div class="welcome-shield">
            <svg viewBox="0 0 64 64" fill="none">
              <path d="M32 4L8 16v16c0 14.4 10.24 27.84 24 32 13.76-4.16 24-17.6 24-32V16L32 4z"
                    stroke="currentColor" stroke-width="1.5" fill="none"
                    style="color: var(--green); filter: drop-shadow(0 0 10px rgba(0,229,118,0.3))"/>
              <path d="M22 32l6 6 14-14" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                    style="color: var(--green)"/>
            </svg>
          </div>
          <h2>Contract-Verified Business Agent</h2>
          <p>Every tool call is validated by formal contracts at runtime via AILANG WASM.
             Invoice chains 4 deep, insurance covers 768 paths,
             payroll guarantees net &ge; 0, shipping clamps discounts. Provably safe.</p>
          <div class="feature-tags">
            <span class="feature-tag calc">Invoice 4-deep chain</span>
            <span class="feature-tag file">Insurance 768 paths</span>
            <span class="feature-tag sql">Payroll net &ge; 0</span>
            <span class="feature-tag div">Risk bounded [0,200]</span>
          </div>
          <p style="margin-top:8px"><kbd>Enter</kbd> to send &middot; Click mic for voice &middot; "Test Safety" for demo</p>
          <div class="init-log" id="initLog"></div>
        </div>
      </div>

      <div class="input-area">
        <div class="input-row">
          <button class="btn-mic" id="btnMic" onclick="toggleMic()" title="Toggle microphone" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
              <line x1="12" y1="19" x2="12" y2="23"/>
              <line x1="8" y1="23" x2="16" y2="23"/>
            </svg>
          </button>
          <div class="input-wrap">
            <textarea class="input-field" id="inputField" rows="1"
                      placeholder="Loading AILANG WASM..."
                      onkeydown="handleKeydown(event)"
                      oninput="autoResize(this)" disabled></textarea>
          </div>
          <button class="btn-send" id="btnSend" onclick="sendMessage()" disabled>Send</button>
        </div>
      </div>
    </div>

    <!-- Right Panel: Safety Dashboard -->
    <div class="panel-safety">
      <div class="panel-header">
        <span>Safety Dashboard</span>
        <div class="indicator">
          <span id="contractsLabel">0 contracts checked</span>
        </div>
      </div>

      <div class="safety-split">
        <!-- Left: Summary (ring + cards) -->
        <div class="safety-summary">
          <!-- Percentage Ring -->
          <div class="safety-ring-section">
            <div class="ring-container">
              <svg class="ring-svg" viewBox="0 0 160 160">
                <circle class="ring-bg" cx="80" cy="80" r="68"/>
                <circle class="ring-fill" id="ringFill" cx="80" cy="80" r="68"
                        stroke-dasharray="427.26" stroke-dashoffset="427.26"/>
              </svg>
              <div class="ring-center">
                <div class="ring-pct" id="ringPct">--</div>
                <div class="ring-label">Pass Rate</div>
              </div>
            </div>
            <div class="ring-sublabel" id="ringSubLabel">0 / 0 contracts enforced</div>
          </div>

          <!-- Tool Status Cards -->
          <div class="safety-cards">
            <div class="safety-card" id="cardInvoice">
              <div class="sc-indicator dim" id="invoiceIndicator"></div>
              <div class="sc-content">
                <div class="sc-title">Invoice</div>
                <div class="sc-detail" id="invoiceDetail">4-deep contract chain</div>
                <div class="sc-params">subtotal &middot; tier &middot; taxRegion &middot; promoCode</div>
              </div>
              <div class="sc-stats">
                <div class="sc-count" id="invoiceCount">0</div>
                <div class="sc-sublabel">calls</div>
              </div>
            </div>
            <div class="safety-card" id="cardInsurance">
              <div class="sc-indicator dim" id="insuranceIndicator"></div>
              <div class="sc-content">
                <div class="sc-title">Insurance</div>
                <div class="sc-detail" id="insuranceDetail">768 verified paths</div>
                <div class="sc-params">ageBand &middot; riskTier &middot; history &middot; coverage &middot; region</div>
              </div>
              <div class="sc-stats">
                <div class="sc-count" id="insuranceCount">0</div>
                <div class="sc-sublabel">calls</div>
              </div>
            </div>
            <div class="safety-card" id="cardPayroll">
              <div class="sc-indicator dim" id="payrollIndicator"></div>
              <div class="sc-content">
                <div class="sc-title">Payroll</div>
                <div class="sc-detail" id="payrollDetail">net &ge; 0 invariant</div>
                <div class="sc-params">hourlyRate &middot; hoursWorked</div>
              </div>
              <div class="sc-stats">
                <div class="sc-count" id="payrollCount">0</div>
                <div class="sc-sublabel">calls</div>
              </div>
            </div>
            <div class="safety-card" id="cardShipping">
              <div class="sc-indicator dim" id="shippingIndicator"></div>
              <div class="sc-content">
                <div class="sc-title">Shipping</div>
                <div class="sc-detail" id="shippingDetail">Discount clamping</div>
                <div class="sc-params">region &middot; priority &middot; weightKg &middot; discount</div>
              </div>
              <div class="sc-stats">
                <div class="sc-count" id="shippingCount">0</div>
                <div class="sc-sublabel">calls</div>
              </div>
            </div>
            <div class="safety-card" id="cardRisk">
              <div class="sc-indicator dim" id="riskIndicator"></div>
              <div class="sc-content">
                <div class="sc-title">Risk Score</div>
                <div class="sc-detail" id="riskDetail">Bounded [0, 200]</div>
                <div class="sc-params">severity &middot; source &middot; repeatCount</div>
              </div>
              <div class="sc-stats">
                <div class="sc-count" id="riskCount">0</div>
                <div class="sc-sublabel">calls</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Contract Log -->
        <div class="contract-log">
          <div class="log-header">
            <span>Contract Log</span>
            <span class="log-count" id="logCount">0 entries</span>
          </div>
          <div class="log-entries" id="logEntries">
            <div class="log-empty" id="logEmpty">Waiting for tool calls...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================
       FOOTER — BUDGET METERS
       ============================================================ -->
  <div class="footer-budgets">
    <div class="budget-meter">
      <span class="bm-label">Stream</span>
      <div class="bm-bar-wrap"><div class="bm-bar" id="budgetStreamBar" style="width:0%"></div></div>
      <span class="bm-text" id="budgetStreamText">0 / 50</span>
    </div>
    <div class="budget-meter">
      <span class="bm-label">Tools</span>
      <div class="bm-bar-wrap"><div class="bm-bar" id="budgetFsBar" style="width:0%"></div></div>
      <span class="bm-text" id="budgetFsText">0 / 50</span>
    </div>
    <div class="budget-meter">
      <span class="bm-label">Blocked</span>
      <div class="bm-bar-wrap"><div class="bm-bar" id="budgetNetBar" style="width:0%"></div></div>
      <span class="bm-text" id="budgetNetText">0</span>
    </div>
    <div class="footer-spacer"></div>
    <div class="footer-branding"><span class="ail">AILANG</span> Contract-Verified Business Tools</div>
  </div>
</div>

<!-- AILANG WASM Runtime -->
<script src="../../wasm/wasm_exec.js"></script>
<script src="../../wasm/ailang-repl.js"></script>
<script src="../shared/gemini-live-core.js"></script>

<script>
// ================================================================
// AILANG Safe Agent — Browser Client (WASM)
//
// ALL contract verification runs through AILANG WASM.
// WebSocket via GeminiLiveCore (std/stream effects).
// ================================================================

// ── Module Names ──
const STREAM_MODULE = 'streaming/gemini_live/gemini_live_browser';
const AGENT_MODULE  = 'streaming/safe_agent/services/business_browser';

const SYSTEM_INSTRUCTION =
  'You are a business consultant demonstrating AILANG, a new programming language with formal contract verification. ' +
  'Speak with a British English accent. Keep responses conversational and concise. ' +
  'You have 5 tools: invoice, insurance, payroll, shipping, riskScore. ' +
  'Each tool is written in AILANG with requires/ensures contracts that are mathematically proven correct by a Z3 solver. ' +
  'The contracts guarantee things like: invoice totals are always non-negative (4-deep function chain), ' +
  'insurance premiums are positive across all 768 input combinations, ' +
  'take-home pay never goes negative, shipping costs are clamped so customers are never paid to ship, ' +
  'and risk scores are bounded between 0 and 200. ' +
  'These AILANG contracts run live in the browser via WebAssembly. ' +
  'Tool parameters use pence internally but convert user amounts to pence (multiply by 100). When presenting results, convert pence back to pounds (divide by 100), like £50.00. ' +
  'Use the tools freely when the user asks. Do not worry about validation — AILANG contracts handle it. ' +
  'If a contract blocks a call, explain what the contract caught and why it matters for business safety. ' +
  'Wait for the user to ask before calling tools. Greet them briefly, mention this is an AILANG contract verification demo, and ask how you can help.';

// ── Safety State ──
const safety = {
  total: 0, passed: 0, failed: 0, contractsChecked: 0,
  invoice:   { calls: 0, blocked: 0 },
  insurance: { calls: 0, blocked: 0 },
  payroll:   { calls: 0, blocked: 0 },
  shipping:  { calls: 0, blocked: 0 },
  risk:      { calls: 0, blocked: 0 }
};

const budgets = {
  stream: { used: 0, limit: 50 },
  fs:     { used: 0, limit: 10 },
  net:    { used: 0, limit: 5 }
};

const logEntries = [];
let currentAgentMsg = null;
let currentUserMsg = null;

// ── DOM Cache ──
const $ = {};
function cacheDom() {
  $.messages = document.getElementById('messages');
  $.welcome = document.getElementById('welcome');
  $.initLog = document.getElementById('initLog');
  $.inputField = document.getElementById('inputField');
  $.btnSend = document.getElementById('btnSend');
  $.btnMic = document.getElementById('btnMic');
  $.btnTestSafety = document.getElementById('btnTestSafety');
  $.wsStatus = document.getElementById('wsStatus');
  $.wsLabel = document.getElementById('wsLabel');
  $.streamDot = document.getElementById('streamDot');
  $.streamLabel = document.getElementById('streamLabel');
  $.configPanel = document.getElementById('configPanel');
  $.apiKeyInput = document.getElementById('apiKeyInput');
  $.voiceSelect = document.getElementById('voiceSelect');
  $.ringFill = document.getElementById('ringFill');
  $.ringPct = document.getElementById('ringPct');
  $.ringSubLabel = document.getElementById('ringSubLabel');
  $.contractsLabel = document.getElementById('contractsLabel');
  $.logEntries = document.getElementById('logEntries');
  $.logCount = document.getElementById('logCount');
  $.logEmpty = document.getElementById('logEmpty');
  $.vuFill = document.getElementById('vuFill');
  $.vuDb = document.getElementById('vuDb');
}

// ── GeminiLiveCore Instance ──
const core = new GeminiLiveCore({
  modules: [
    { name: STREAM_MODULE, path: '../../ailang/streaming/gemini_live/gemini_live_browser.ail' },
    { name: 'streaming/safe_agent/services/business_tools', path: '../../ailang/streaming/safe_agent/services/business_tools.ail' },
    { name: AGENT_MODULE, path: '../../ailang/streaming/safe_agent/services/business_browser.ail' },
  ],
  stdlibs: ['std/json', 'std/option', 'std/result', 'std/string', 'std/list',
            'std/io', 'std/stream', 'std/math'],
  playbackRate: 48000,
  sourceRate: 24000,
  micRate: 16000,
  fftSize: 2048,
  canvasHeight: 64,
  onEvent: handleAILANGEvent,
  onStatsUpdate: function(stats) {
    if (core.lastPcmChunk) {
      var vu = core.computeVU(core.lastPcmChunk);
      $.vuFill.style.width = vu.pct + '%';
      $.vuDb.textContent = vu.db > -60 ? vu.db.toFixed(1) + ' dB' : '-\u221E dB';
    }
  },
  onLog: (type, html) => {
    if ($.initLog && $.welcome) {
      $.initLog.innerHTML += '<div>' + (type === 'ok' ? '<span class="ok">OK</span> ' : '') + html + '</div>';
    }
  },
  onWasmReady: () => {
    populateVoices();
    $.btnTestSafety.disabled = false;
    $.btnSend.disabled = false;
    $.btnMic.disabled = false;
    $.inputField.disabled = false;
    $.inputField.placeholder = 'Ask the safe agent...';
  },
  onWasmError: () => {},
  onConnectionChange: (state) => {
    if (state === 'connected') setWsStatus('connected');
    else setWsStatus('disconnected');
  },
  onFallbackActivated: () => {},
  onFallbackDeactivated: () => {},
  onStatsUpdate: () => {}
});

// ── Config ──
function toggleConfig() {
  $.configPanel.classList.toggle('open');
}

function saveConfig() {
  const key = $.apiKeyInput.value.trim();
  const voice = $.voiceSelect.value;
  if (key) localStorage.setItem('gemini-api-key', key);
  if (voice) localStorage.setItem('ailang_safe_agent_voice', voice);
}

function loadConfig() {
  const savedKey = localStorage.getItem('gemini-api-key');
  const savedVoice = localStorage.getItem('ailang_safe_agent_voice');
  if (savedKey) $.apiKeyInput.value = savedKey;
  if (savedVoice) $.voiceSelect.value = savedVoice;
}

function populateVoices() {
  if (!core.wasmReady) return;
  try {
    const raw = core.callAILANG('voiceCatalog');
    if (!raw) return;
    const voices = JSON.parse(raw);
    $.voiceSelect.innerHTML = '';
    voices.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v.name;
      opt.textContent = v.name + ' (' + v.desc + ')';
      $.voiceSelect.appendChild(opt);
    });
    const saved = localStorage.getItem('ailang_safe_agent_voice');
    if (saved) $.voiceSelect.value = saved;
  } catch (e) { /* voice catalog optional */ }
}

// ── Tool Declarations (sent to Gemini) ──
function getToolDeclarations() {
  return [{
    functionDeclarations: [
      {
        name: 'invoice',
        description: 'Calculate invoice total with tier discount, regional tax, and promo rebate. 4-deep contract chain. All values in cents. Tiers: enterprise, business, starter, trial, free. Tax regions: us_standard, us_reduced, eu_standard, eu_reduced, tax_exempt. Promo codes must start with "PROMO-" and be 8+ chars.',
        parameters: {
          type: 'object',
          properties: {
            subtotalCents: { type: 'number', description: 'Invoice subtotal in cents (must be >= 0)' },
            tier: { type: 'string', enum: ['enterprise', 'business', 'starter', 'trial', 'free'] },
            taxRegion: { type: 'string', enum: ['us_standard', 'us_reduced', 'eu_standard', 'eu_reduced', 'tax_exempt'] },
            promoCode: { type: 'string', description: 'Promo code (e.g. "PROMO-LAUNCH2024") or empty string' }
          },
          required: ['subtotalCents', 'tier', 'taxRegion', 'promoCode']
        }
      },
      {
        name: 'insurance',
        description: 'Estimate insurance premium. 768 verified input paths. Returns premium in cents. Age bands: youth, adult, senior, elderly. Risk tiers: low, medium, high, critical. Claim history: clean, minor, major, multiple. Coverage: basic, standard, premium, platinum. Regions: urban, suburban, rural.',
        parameters: {
          type: 'object',
          properties: {
            ageBand: { type: 'string', enum: ['youth', 'adult', 'senior', 'elderly'] },
            riskTier: { type: 'string', enum: ['low', 'medium', 'high', 'critical'] },
            claimHistory: { type: 'string', enum: ['clean', 'minor', 'major', 'multiple'] },
            coverage: { type: 'string', enum: ['basic', 'standard', 'premium', 'platinum'] },
            region: { type: 'string', enum: ['urban', 'suburban', 'rural'] }
          },
          required: ['ageBand', 'riskTier', 'claimHistory', 'coverage', 'region']
        }
      },
      {
        name: 'payroll',
        description: 'Calculate take-home pay with federal (3 brackets), state (5%), and FICA taxes. Key invariant: net pay is always >= 0. Rate in cents, hours as integer.',
        parameters: {
          type: 'object',
          properties: {
            hourlyRateCents: { type: 'number', description: 'Hourly rate in cents (e.g. 5000 for 50/hr). Must be >= 0.' },
            hoursWorked: { type: 'number', description: 'Hours worked (integer). Must be >= 0.' }
          },
          required: ['hourlyRateCents', 'hoursWorked']
        }
      },
      {
        name: 'shipping',
        description: 'Calculate shipping cost with priority multiplier, weight surcharge, and discount clamping. Discount is clamped so cost never goes negative. Regions: domestic, regional, international. Priority: economy, standard, express, overnight.',
        parameters: {
          type: 'object',
          properties: {
            region: { type: 'string', enum: ['domestic', 'regional', 'international'] },
            priority: { type: 'string', enum: ['economy', 'standard', 'express', 'overnight'] },
            weightKg: { type: 'number', description: 'Weight in kg (must be >= 0)' },
            discountCents: { type: 'number', description: 'Loyalty discount in cents (must be >= 0)' }
          },
          required: ['region', 'priority', 'weightKg', 'discountCents']
        }
      },
      {
        name: 'riskScore',
        description: 'Assess business risk. Score bounded [0, 200]. Severity: critical, high, medium, low. Source: internal, external, automated. Repeat count: 0-10.',
        parameters: {
          type: 'object',
          properties: {
            severity: { type: 'string', enum: ['critical', 'high', 'medium', 'low'] },
            source: { type: 'string', enum: ['internal', 'external', 'automated'] },
            repeatCount: { type: 'number', description: 'Number of repeat incidents (0-10, must be >= 0)' }
          },
          required: ['severity', 'source', 'repeatCount']
        }
      }
    ]
  }];
}

// ================================================================
// AILANG WASM Tool Dispatch — Contract Verification
// ================================================================

function handleToolCallFromGemini(toolCall) {
  const calls = toolCall.functionCalls || [];
  for (const call of calls) {
    const result = dispatchToolViaWASM(call.id || '', call.name || '', call.args || {});
    budgets.stream.used++;
    updateBudgets();

    // Send response back via AILANG
    const responseText = result.rejected
      ? 'Contract violation: ' + result.result
      : result.result;
    const resp = core.callAILANG('buildToolResponse', call.id || '', call.name || '', responseText);
    const conn = core.getActiveConnection();
    if (conn && resp) {
      conn.ws.send(resp);
    } else if (conn) {
      conn.ws.send(JSON.stringify({
        toolResponse: { functionResponses: [{ id: call.id, name: call.name, response: { result: responseText } }] }
      }));
    }
  }
}

// Helpers: callAILANGModule may return native types (new WASM) or strings (old WASM)
function wasmBool(v) { return v === true || v === 'true'; }
function wasmInt(v) { return typeof v === 'number' ? v : parseInt(v, 10); }

// Helper: format pence as £X.XX
function fmtNum(c) { return '\u00A3' + (c / 100).toFixed(2); }

function dispatchToolViaWASM(id, name, args) {
  let result = null;
  let rejected = false;
  let contractChecks = [];

  safety.total++;
  safety.contractsChecked++;

  switch (name) {
    case 'invoice': {
      const subtotal = Math.round(typeof args.subtotalCents === 'number' ? args.subtotalCents : 0);
      const tier = args.tier || 'free';
      const region = args.taxRegion || 'us_standard';
      const promo = args.promoCode || '';
      safety.invoice.calls++;

      contractChecks.push({ name: 'subtotal >= 0', pass: subtotal >= 0 });

      const json = core.callAILANGModule(AGENT_MODULE, 'calcInvoice', subtotal, tier, region, promo);
      if (json) {
        try {
          const p = JSON.parse(json);
          if (p.ok === true || p.ok === 'true') {
            result = 'Total: ' + fmtNum(p.total) + ' (after ' + tier + ' discount: ' + fmtNum(p.afterDiscount) + ', tax: ' + fmtNum(p.tax) + ', rebate: ' + fmtNum(p.rebate) + ')';
            contractChecks.push({ name: 'tierDiscount >= 0', pass: true });
            contractChecks.push({ name: 'tax >= 0', pass: true });
            contractChecks.push({ name: 'rebate >= 0', pass: true });
            contractChecks.push({ name: 'total >= 0 (4-deep chain)', pass: true });
          } else {
            rejected = true;
            result = p.error;
            safety.invoice.blocked++;
          }
        } catch (e) { rejected = true; result = 'WASM parse error'; }
      } else { rejected = true; result = 'WASM call failed'; }
      updateCardStatus('invoice', rejected ? 'red' : 'green');
      break;
    }

    case 'insurance': {
      const ageBand = args.ageBand || 'adult';
      const riskTier = args.riskTier || 'low';
      const history = args.claimHistory || 'clean';
      const coverage = args.coverage || 'basic';
      const region = args.region || 'rural';
      safety.insurance.calls++;

      const json = core.callAILANGModule(AGENT_MODULE, 'calcInsurance', ageBand, riskTier, history, coverage, region);
      if (json) {
        try {
          const p = JSON.parse(json);
          if (p.ok === true || p.ok === 'true') {
            result = 'Premium: ' + fmtNum(p.premium) + ' (base: ' + fmtNum(p.base) + ', multiplier: ' + p.multiplier + '%, surcharge: ' + fmtNum(p.surcharge) + ')';
            contractChecks.push({ name: 'basePremium >= 100', pass: true });
            contractChecks.push({ name: 'riskMultiplier >= 100%', pass: true });
            contractChecks.push({ name: 'surcharge >= 0', pass: true });
            contractChecks.push({ name: 'premium >= 100 (768 paths)', pass: true });
          } else {
            rejected = true;
            result = p.error;
            safety.insurance.blocked++;
          }
        } catch (e) { rejected = true; result = 'WASM parse error'; }
      } else { rejected = true; result = 'WASM call failed'; }
      updateCardStatus('insurance', rejected ? 'red' : 'green');
      break;
    }

    case 'payroll': {
      const rate = Math.round(typeof args.hourlyRateCents === 'number' ? args.hourlyRateCents : 0);
      const hours = Math.round(typeof args.hoursWorked === 'number' ? args.hoursWorked : 0);
      safety.payroll.calls++;

      contractChecks.push({ name: 'rate >= 0', pass: rate >= 0 });
      contractChecks.push({ name: 'hours >= 0', pass: hours >= 0 });

      const json = core.callAILANGModule(AGENT_MODULE, 'calcPayroll', rate, hours);
      if (json) {
        try {
          const p = JSON.parse(json);
          if (p.ok === true || p.ok === 'true') {
            result = 'Net: ' + fmtNum(p.net) + ' (gross: ' + fmtNum(p.gross) + ', fed: ' + fmtNum(p.federal) + ', state: ' + fmtNum(p.state) + ', FICA: ' + fmtNum(p.fica) + ')';
            contractChecks.push({ name: 'gross >= 0', pass: true });
            contractChecks.push({ name: 'federal <= taxable', pass: true });
            contractChecks.push({ name: 'deductions <= gross', pass: true });
            contractChecks.push({ name: 'net >= 0 (key invariant)', pass: true });
          } else {
            rejected = true;
            result = p.error;
            safety.payroll.blocked++;
          }
        } catch (e) { rejected = true; result = 'WASM parse error'; }
      } else { rejected = true; result = 'WASM call failed'; }
      updateCardStatus('payroll', rejected ? 'red' : 'green');
      break;
    }

    case 'shipping': {
      const region = args.region || 'domestic';
      const priority = args.priority || 'economy';
      const weight = Math.round(typeof args.weightKg === 'number' ? args.weightKg : 0);
      const discount = Math.round(typeof args.discountCents === 'number' ? args.discountCents : 0);
      safety.shipping.calls++;

      contractChecks.push({ name: 'weight >= 0', pass: weight >= 0 });
      contractChecks.push({ name: 'discount >= 0', pass: discount >= 0 });

      const json = core.callAILANGModule(AGENT_MODULE, 'calcShipping', region, priority, weight, discount);
      if (json) {
        try {
          const p = JSON.parse(json);
          if (p.ok === true || p.ok === 'true') {
            const wasClamped = p.cost === 0 && p.discount > 0;
            result = 'Cost: ' + fmtNum(p.cost) + ' (base: ' + fmtNum(p.baseCost) + ', priority: ' + p.multiplier + '%, weight: ' + fmtNum(p.weightSurcharge) + ', discount: -' + fmtNum(p.discount) + ')';
            contractChecks.push({ name: 'baseCost >= 0', pass: true });
            contractChecks.push({ name: 'priority >= 100%', pass: true });
            if (wasClamped) contractChecks.push({ name: 'discount clamped to 0', pass: true });
            contractChecks.push({ name: 'cost >= 0 (clamped)', pass: true });
          } else {
            rejected = true;
            result = p.error;
            safety.shipping.blocked++;
          }
        } catch (e) { rejected = true; result = 'WASM parse error'; }
      } else { rejected = true; result = 'WASM call failed'; }
      updateCardStatus('shipping', rejected ? 'red' : 'green');
      break;
    }

    case 'riskScore': {
      const severity = args.severity || 'low';
      const source = args.source || 'automated';
      const repeats = Math.round(typeof args.repeatCount === 'number' ? args.repeatCount : 0);
      safety.risk.calls++;

      contractChecks.push({ name: 'repeatCount >= 0', pass: repeats >= 0 });

      const json = core.callAILANGModule(AGENT_MODULE, 'calcRisk', severity, source, repeats);
      if (json) {
        try {
          const p = JSON.parse(json);
          if (p.ok === true || p.ok === 'true') {
            result = 'Risk score: ' + p.score + '/200 (severity: ' + p.severity + ', source: +' + p.source + ', repeat: +' + p.repeat + ')';
            contractChecks.push({ name: 'severity in [0,100]', pass: true });
            contractChecks.push({ name: 'source in [0,50]', pass: true });
            contractChecks.push({ name: 'repeat capped at 50', pass: true });
            contractChecks.push({ name: 'total bounded [0,200]', pass: true });
          } else {
            rejected = true;
            result = p.error;
            safety.risk.blocked++;
          }
        } catch (e) { rejected = true; result = 'WASM parse error'; }
      } else { rejected = true; result = 'WASM call failed'; }
      updateCardStatus('risk', rejected ? 'red' : 'green');
      break;
    }

    default: {
      rejected = true;
      result = 'Unknown tool: ' + name;
    }
  }

  // Both allowed AND blocked calls are contract successes —
  // "blocked" means the contract correctly caught a dangerous input.
  safety.passed++;
  if (rejected) safety.failed++;

  addToolCard(name, args, result, rejected, contractChecks);
  addLogEntry(name, args, result, rejected, contractChecks);
  updateRing();
  updateBudgets();
  updateCardCounts();

  return { result, rejected, contractChecks };
}

// ================================================================
// AILANG Event Handler (from GeminiLiveCore IO effect)
// ================================================================

function handleAILANGEvent(event) {
  switch (event.type) {
    case 'setup':
      core.sessionReady = true;
      $.btnSend.disabled = false;
      $.inputField.disabled = false;
      addSystemMessage('Setup complete. All tools verified and ready.');
      setStreamIndicator(false);
      break;

    case 'sent':
      setStreamIndicator(true);
      break;

    case 'turnComplete':
      currentUserMsg = null;
      finishAgentMessage();
      setStreamIndicator(false);
      $.btnSend.disabled = false;
      $.inputField.disabled = false;
      break;

    case 'modelTurn':
      currentUserMsg = null;
      if (event.parts && Array.isArray(event.parts)) {
        event.parts.forEach(part => {
          if (part.text) {
            if (!currentAgentMsg) {
              currentAgentMsg = createAgentMessage();
              setStreamIndicator(true);
            }
            appendToAgent(currentAgentMsg, part.text);
          }
          if (part.inlineData && part.inlineData.data) {
            core.handleAudioFrame(part.inlineData.data);
          }
        });
      }
      break;

    case 'inputTranscript':
      if (event.text) {
        if (!currentUserMsg) {
          currentUserMsg = addUserMessage(event.text);
        } else {
          var body = currentUserMsg.querySelector('.msg-text');
          if (body) body.textContent += event.text;
        }
        $.messages.scrollTop = $.messages.scrollHeight;
      }
      break;

    case 'outputTranscript':
      if (event.text) {
        if (!currentAgentMsg) currentAgentMsg = createAgentMessage();
        appendToAgent(currentAgentMsg, event.text.replace(/\n+/g, ' '));
      }
      break;

    case 'toolCall':
      currentUserMsg = null;
      finishAgentMessage();
      if (event.calls) handleToolCallFromGemini({ functionCalls: event.calls });
      break;

    case 'opened':
      setWsStatus('connected');
      break;

    case 'closed':
      core.sessionReady = false;
      setWsStatus('disconnected');
      setStreamIndicator(false);
      break;

    case 'error':
      addErrorMessage(event.text || 'Unknown error');
      break;

    case 'log':
      break;
  }
}

// ================================================================
// Connection
// ================================================================

let _connecting = false;

async function connectGemini(initialPrompt) {
  // Guard against overlapping connection attempts (mic + text at the same time)
  if (_connecting) return;
  _connecting = true;

  const key = $.apiKeyInput.value.trim() || localStorage.getItem('gemini-api-key');
  if (!key) { _connecting = false; toggleConfig(); addErrorMessage('Set your Gemini API key first.'); return; }
  saveConfig();

  if (!core.wasmReady) {
    _connecting = false;
    addErrorMessage('AILANG WASM not loaded');
    return;
  }

  core.sessionReady = false;
  core.resetStats();
  $.btnSend.disabled = true;
  $.inputField.disabled = true;
  setWsStatus('connecting');
  core.deactivateFallbackMode();

  await core.initAudio();

  const voice = $.voiceSelect.value || 'Orus';
  const toolsJson = JSON.stringify(getToolDeclarations());
  const prompt = initialPrompt || '';

  addSystemMessage('Starting AILANG session with tools (std/stream effects)...');

  try {
    const result = await core.wasmEngine.callAsync(
      STREAM_MODULE, 'startSessionWithTools',
      key, voice, SYSTEM_INSTRUCTION, prompt, toolsJson
    );
    if (!result.success) addErrorMessage('Session error: ' + (result.error || 'unknown'));
  } catch (e) {
    addErrorMessage('Session failed: ' + e.message);
  }

  _connecting = false;
  core.sessionReady = false;
  setWsStatus('disconnected');
}
// ── Send Text ──
function sendMessage() {
  const text = $.inputField.value.trim();
  if (!text) return;

  addUserMessage(text);
  $.inputField.value = '';
  $.inputField.style.height = 'auto';

  if (!core.getActiveConnection()) {
    connectGemini(text);
    return;
  }

  const msgJson = core.callAILANG('buildTextMessage', text);
  const conn = core.getActiveConnection();
  if (conn && msgJson) conn.ws.send(msgJson);
  else if (conn) {
    conn.ws.send(JSON.stringify({
      clientContent: { turns: [{ role: 'user', parts: [{ text }] }], turnComplete: true }
    }));
  }

  core.resetStats();
  core.markPromptSent();
  core.clearAudioQueue();
  $.btnSend.disabled = true;
  $.inputField.disabled = true;
  setStreamIndicator(true);
}

// ── Microphone ──
async function toggleMic() {
  if (core.isRecording) {
    await core.toggleMic(() => {});
    $.btnMic.classList.remove('recording');
    return;
  }
  const started = await core.toggleMic((b64) => {
    const conn = core.getActiveConnection();
    if (conn && core.sessionReady) {
      const chunkJson = core.callAILANG('buildAudioChunk', b64);
      conn.ws.send(chunkJson || JSON.stringify({
        realtimeInput: { mediaChunks: [{ mimeType: 'audio/pcm;rate=16000', data: b64 }] }
      }));
    }
  });
  if (started) {
    $.btnMic.classList.add('recording');
    if (!core.getActiveConnection()) connectGemini('');
  }
}

// ── Input ──
function handleKeydown(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

// ================================================================
// UI Helpers
// ================================================================

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function setWsStatus(state) {
  $.wsStatus.classList.remove('connected');
  if (state === 'connected') {
    $.wsStatus.classList.add('connected');
    $.wsLabel.textContent = 'Connected';
  } else if (state === 'connecting') {
    $.wsLabel.textContent = 'Connecting...';
  } else {
    $.wsLabel.textContent = 'Disconnected';
  }
}

function setStreamIndicator(active) {
  $.streamDot.classList.toggle('active', active);
  $.streamLabel.textContent = active ? 'streaming' : 'idle';
}

function removeWelcome() {
  if ($.welcome && $.welcome.parentNode) $.welcome.remove();
}

function addUserMessage(text) {
  removeWelcome();
  finishAgentMessage();
  currentUserMsg = null;
  const div = document.createElement('div');
  div.className = 'msg msg-user';
  const label = document.createElement('div');
  label.className = 'msg-label';
  label.textContent = 'You';
  const body = document.createElement('div');
  body.className = 'msg-text';
  body.textContent = text.replace(/\n+/g, ' ').trim();
  div.appendChild(label);
  div.appendChild(body);
  $.messages.appendChild(div);
  $.messages.scrollTop = $.messages.scrollHeight;
  return div;
}

function createAgentMessage() {
  removeWelcome();
  const div = document.createElement('div');
  div.className = 'msg msg-agent streaming';
  div.innerHTML = '<div class="msg-label"><span class="arrow">&#9656;</span> Agent</div><div class="msg-text"><span class="cursor-blink"></span></div>';
  $.messages.appendChild(div);
  $.messages.scrollTop = $.messages.scrollHeight;
  return div;
}

function appendToAgent(el, text) {
  if (!el) return;
  const textEl = el.querySelector('.msg-text');
  const cursor = textEl.querySelector('.cursor-blink');
  if (cursor) cursor.insertAdjacentText('beforebegin', text);
  else textEl.textContent += text;
  $.messages.scrollTop = $.messages.scrollHeight;
}

// Lightweight markdown → HTML (inline only, no external lib)
function renderMarkdown(raw) {
  let s = raw;
  // Escape HTML first
  s = s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  // Headings: ## at line start
  s = s.replace(/^### (.+)$/gm, '<strong style="font-size:1.05em">$1</strong>');
  s = s.replace(/^## (.+)$/gm, '<strong style="font-size:1.1em">$1</strong>');
  s = s.replace(/^# (.+)$/gm, '<strong style="font-size:1.15em">$1</strong>');
  // Bold + italic
  s = s.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // Inline code
  s = s.replace(/`([^`]+)`/g, '<code style="background:var(--bg-surface);padding:1px 4px;border-radius:3px">$1</code>');
  // Bullet lists
  s = s.replace(/^[-*] (.+)$/gm, '&bull; $1');
  // Line breaks
  s = s.replace(/\n/g, '<br>');
  return s;
}

function finishAgentMessage() {
  if (currentAgentMsg) {
    currentAgentMsg.classList.remove('streaming');
    const cursor = currentAgentMsg.querySelector('.cursor-blink');
    if (cursor) cursor.remove();
    // Render markdown in the completed message
    const textEl = currentAgentMsg.querySelector('.msg-text');
    if (textEl) {
      const raw = textEl.textContent;
      textEl.innerHTML = renderMarkdown(raw);
    }
    currentAgentMsg = null;
  }
}

function addToolCard(name, args, result, rejected, checks) {
  removeWelcome();
  const div = document.createElement('div');
  div.className = 'msg tool-card ' + (rejected ? 'fail' : 'pass');

  const argsStr = Object.entries(args).map(function(e) { return e[0] + ': ' + JSON.stringify(e[1]); }).join(', ');
  const checksHtml = checks.map(function(c) {
    return '<span class="check-pill ' + (c.pass ? 'pass' : 'fail') + '">' +
      (c.pass ? '\u2713' : '\u2717') + ' ' + c.name + '</span>';
  }).join('');

  div.innerHTML =
    '<div class="tool-card-header" onclick="this.parentElement.classList.toggle(\'collapsed\')">' +
      '<span class="tool-name"><span class="fn-icon">\u0192</span> ' + escapeHtml(name) + '</span>' +
      '<span class="contract-badge ' + (rejected ? 'blocked' : 'pass') + '">' +
        '<span class="icon">' + (rejected ? '\u26D4' : '\u2713') + '</span> ' +
        (rejected ? 'BLOCKED' : 'ALLOWED') +
      '</span>' +
    '</div>' +
    '<div class="tool-card-body">' +
      '<div class="tc-section">' +
        '<div class="tc-section-label">Input</div>' +
        '<div class="tc-section-content">' + escapeHtml(argsStr) + '</div>' +
      '</div>' +
      '<div class="tc-section">' +
        '<div class="tc-section-label">Contracts</div>' +
        '<div class="contract-checks">' + checksHtml + '</div>' +
      '</div>' +
      '<div class="tc-section">' +
        '<div class="tc-section-label">' + (rejected ? 'Blocked' : 'Output') + '</div>' +
        '<div class="tc-section-content ' + (rejected ? 'rejected' : 'result') + '">' + escapeHtml(result) + '</div>' +
      '</div>' +
    '</div>';
  $.messages.appendChild(div);
  $.messages.scrollTop = $.messages.scrollHeight;
}

function addErrorMessage(text) {
  removeWelcome();
  const div = document.createElement('div');
  div.className = 'msg msg-error';
  div.textContent = text;
  $.messages.appendChild(div);
  $.messages.scrollTop = $.messages.scrollHeight;
}

function addSystemMessage(text) {
  removeWelcome();
  const div = document.createElement('div');
  div.className = 'msg msg-system';
  div.textContent = text;
  $.messages.appendChild(div);
  $.messages.scrollTop = $.messages.scrollHeight;
}

// ── Safety Dashboard ──
function updateRing() {
  const circumference = 2 * Math.PI * 68;
  if (safety.total === 0) {
    $.ringFill.style.strokeDashoffset = circumference;
    $.ringPct.textContent = '--';
    $.ringPct.style.color = 'var(--text-dim)';
    $.ringFill.style.stroke = 'var(--text-dim)';
    $.ringSubLabel.textContent = '0 / 0 contracts enforced';
  } else {
    const pct = Math.round((safety.passed / safety.total) * 100);
    $.ringFill.style.strokeDashoffset = circumference - (pct / 100) * circumference;
    $.ringPct.textContent = pct + '%';
    if (pct === 100) {
      $.ringPct.style.color = 'var(--green)';
      $.ringFill.style.stroke = 'var(--green)';
    } else if (pct >= 80) {
      $.ringPct.style.color = 'var(--amber)';
      $.ringFill.style.stroke = 'var(--amber)';
    } else {
      $.ringPct.style.color = 'var(--red)';
      $.ringFill.style.stroke = 'var(--red)';
    }
    const allowed = safety.total - safety.failed;
    $.ringSubLabel.textContent = safety.total + ' enforced: ' + allowed + ' allowed, ' + safety.failed + ' blocked';
  }
  $.contractsLabel.textContent = safety.contractsChecked + ' contracts checked';
}

function updateCardStatus(card, status) {
  document.getElementById(card + 'Indicator').className = 'sc-indicator ' + status;
}

function updateCardCounts() {
  document.getElementById('invoiceCount').textContent = safety.invoice.calls;
  document.getElementById('insuranceCount').textContent = safety.insurance.calls;
  document.getElementById('payrollCount').textContent = safety.payroll.calls;
  document.getElementById('shippingCount').textContent = safety.shipping.calls;
  document.getElementById('riskCount').textContent = safety.risk.calls;
  if (safety.invoice.blocked > 0) document.getElementById('invoiceDetail').textContent = safety.invoice.blocked + ' precondition(s) blocked';
  if (safety.payroll.blocked > 0) document.getElementById('payrollDetail').textContent = safety.payroll.blocked + ' precondition(s) blocked';
  if (safety.shipping.blocked > 0) document.getElementById('shippingDetail').textContent = safety.shipping.blocked + ' precondition(s) blocked';
  if (safety.risk.blocked > 0) document.getElementById('riskDetail').textContent = safety.risk.blocked + ' precondition(s) blocked';
}

function addLogEntry(name, args, result, rejected, checks) {
  if ($.logEmpty) $.logEmpty.remove();
  const now = new Date();
  const ts = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
  const argsShort = Object.values(args).map(function(v) { return JSON.stringify(v); }).join(', ');
  const truncArgs = argsShort.length > 40 ? argsShort.slice(0, 40) + '...' : argsShort;
  const resultShort = result.length > 50 ? result.slice(0, 50) + '...' : result;
  const argsAll = Object.entries(args).map(function(e) { return e[0] + ': ' + JSON.stringify(e[1]); }).join(', ');
  const checksDetail = checks.map(function(c) {
    return '<div class="detail-value ' + (c.pass ? 'ok' : 'err') + '">' + (c.pass ? '\u2713' : '\u2717') + ' ' + escapeHtml(c.name) + '</div>';
  }).join('');

  const entry = document.createElement('div');
  entry.className = 'log-entry ' + (rejected ? 'fail' : 'pass');
  entry.innerHTML =
    '<span class="log-time">' + ts + '</span>' +
    '<span class="log-icon ' + (rejected ? 'fail' : 'pass') + '">' + (rejected ? '\u26D4' : '\u2713') + '</span>' +
    '<span class="log-msg" onclick="this.parentElement.classList.toggle(\'expanded\')">' +
      '<span class="fn">' + escapeHtml(name) + '</span>(' + escapeHtml(truncArgs) + ') &rarr; <span class="' + (rejected ? 'err' : 'val') + '">' + escapeHtml(resultShort) + '</span>' +
      '<div class="log-detail">' +
        '<div class="detail-label">Input</div>' +
        '<div class="detail-value">' + escapeHtml(argsAll) + '</div>' +
        '<div class="detail-label">Contracts</div>' +
        checksDetail +
        '<div class="detail-label">' + (rejected ? 'Blocked' : 'Output') + '</div>' +
        '<div class="detail-value ' + (rejected ? 'err' : 'ok') + '">' + escapeHtml(result) + '</div>' +
      '</div>' +
    '</span>';

  $.logEntries.appendChild(entry);
  $.logEntries.scrollTop = $.logEntries.scrollHeight;
  logEntries.push({ ts, name, args, result, rejected, checks });
  $.logCount.textContent = logEntries.length + ' entries';
}

function updateBudgets() {
  updateBudgetBar('Stream', budgets.stream);
  // Tools meter: total calls
  var toolBudget = { used: safety.total, limit: 50 };
  updateBudgetBar('Fs', toolBudget);
  // Blocked meter: just show count
  var blockedEl = document.getElementById('budgetNetBar');
  var blockedText = document.getElementById('budgetNetText');
  if (blockedEl && blockedText) {
    var pct = safety.total > 0 ? Math.min(100, (safety.failed / safety.total) * 100) : 0;
    blockedEl.style.width = pct + '%';
    blockedEl.className = 'bm-bar' + (safety.failed > 0 ? ' warn' : '');
    blockedText.textContent = safety.failed;
  }
}

function updateBudgetBar(name, budget) {
  const bar = document.getElementById('budget' + name + 'Bar');
  const text = document.getElementById('budget' + name + 'Text');
  const pct = Math.min(100, (budget.used / budget.limit) * 100);
  bar.style.width = pct + '%';
  bar.className = 'bm-bar';
  if (pct >= 90) bar.classList.add('danger');
  else if (pct >= 70) bar.classList.add('warn');
  text.textContent = budget.used + ' / ' + budget.limit;
}

// ================================================================
// MOCK MODE — "Test Safety" Button
// Dispatches through AILANG WASM for contract verification.
// ================================================================
let testRunning = false;

async function runSafetyTest() {
  if (testRunning) return;
  if (!core.wasmReady) { addErrorMessage('AILANG WASM not loaded'); return; }
  testRunning = true;

  $.btnTestSafety.classList.add('active');
  $.btnTestSafety.textContent = 'Running...';

  removeWelcome();
  addSystemMessage('Running business contract safety test suite (12 scenarios via AILANG WASM)...');

  const testCases = [
    // Invoice: 4-deep chain
    { label: 'Invoice: Enterprise, EU tax, valid promo', delay: 400, call: { id: 'test1', name: 'invoice', args: { subtotalCents: 500000, tier: 'enterprise', taxRegion: 'eu_standard', promoCode: 'PROMO-LAUNCH2024' } } },
    { label: 'Invoice: Negative subtotal (BLOCKED)', delay: 500, call: { id: 'test2', name: 'invoice', args: { subtotalCents: -100000, tier: 'business', taxRegion: 'us_standard', promoCode: '' } } },
    { label: 'Invoice: Invalid promo (too short)', delay: 400, call: { id: 'test3', name: 'invoice', args: { subtotalCents: 250000, tier: 'starter', taxRegion: 'us_reduced', promoCode: 'PROMO' } } },
    // Insurance: 768 paths
    { label: 'Insurance: Cheapest (adult, low, clean, basic, rural)', delay: 400, call: { id: 'test4', name: 'insurance', args: { ageBand: 'adult', riskTier: 'low', claimHistory: 'clean', coverage: 'basic', region: 'rural' } } },
    { label: 'Insurance: Most expensive (elderly, critical, multiple, platinum, urban)', delay: 500, call: { id: 'test5', name: 'insurance', args: { ageBand: 'elderly', riskTier: 'critical', claimHistory: 'multiple', coverage: 'platinum', region: 'urban' } } },
    // Payroll: net >= 0
    { label: 'Payroll: 3500/hr, 40 hours', delay: 400, call: { id: 'test6', name: 'payroll', args: { hourlyRateCents: 3500, hoursWorked: 40 } } },
    { label: 'Payroll: Negative rate (BLOCKED)', delay: 500, call: { id: 'test7', name: 'payroll', args: { hourlyRateCents: -1000, hoursWorked: 40 } } },
    // Shipping: discount clamping
    { label: 'Shipping: International express, 15kg, £3.00 discount', delay: 400, call: { id: 'test8', name: 'shipping', args: { region: 'international', priority: 'express', weightKg: 15, discountCents: 300 } } },
    { label: 'Shipping: £99.99 discount clamped to £0', delay: 500, call: { id: 'test9', name: 'shipping', args: { region: 'domestic', priority: 'economy', weightKg: 1, discountCents: 9999 } } },
    { label: 'Shipping: Negative weight (BLOCKED)', delay: 500, call: { id: 'test10', name: 'shipping', args: { region: 'domestic', priority: 'economy', weightKg: -5, discountCents: 0 } } },
    // Risk: bounded [0, 200]
    { label: 'Risk: Low severity, automated, 0 repeats', delay: 400, call: { id: 'test11', name: 'riskScore', args: { severity: 'low', source: 'automated', repeatCount: 0 } } },
    { label: 'Risk: Critical, external, 10 repeats (maxed)', delay: 400, call: { id: 'test12', name: 'riskScore', args: { severity: 'critical', source: 'external', repeatCount: 10 } } },
  ];

  for (const tc of testCases) {
    addSystemMessage('Test: ' + tc.label);
    await sleep(tc.delay);
    dispatchToolViaWASM(tc.call.id, tc.call.name, tc.call.args);
    await sleep(200);
  }

  await sleep(300);
  const allowed = safety.total - safety.failed;
  addSystemMessage(
    'Safety test complete: ' + safety.total + '/' + safety.total + ' contracts enforced via AILANG WASM. ' +
    allowed + ' allowed, ' + safety.failed + ' dangerous calls blocked.'
  );

  $.btnTestSafety.classList.remove('active');
  $.btnTestSafety.textContent = 'Test Safety';
  testRunning = false;
}

function sleep(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

// ── Keyboard shortcuts ──
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && core.isRecording) toggleMic();
});

// ── Init ──
document.addEventListener('DOMContentLoaded', function() {
  cacheDom();
  loadConfig();
  updateRing();
  updateBudgets();
  core.initWaveform(document.getElementById('waveform'));
  core.initWASM();
  $.inputField.focus();
});
</script>

</body>
</html>
